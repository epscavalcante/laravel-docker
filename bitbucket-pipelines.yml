image: php:8.1.18-fpm-alpine3.18

definitions:
  services:
    mysql:
      image: mysql:8.0.33
      environment:
        MYSQL_DATABASE: 'app'
        MYSQL_ROOT_PASSWORD: 'root'
        memory: '256'
  steps:
    - step: &build
        name: 'Build'
        script:
          - apk add openssl
          - apt-get update && apt-get install -y unzip
          - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          - composer -V
          - php -r "file_exists('.env') || copy('.env.example', '.env');"
          - composer install
          - php artisan key:generate
        artifacts:
          - "**"
        caches:
          - composer

    - step: &test
        name: 'Test'
        services: 
          - docker
          - mysql
        caches:
          - composer
        script:
          - php -m
          - docker-php-ext-install pdo pdo_mysql
          - php -m
          - php artisan test
          - php artisan migrate:fresh --force

    - step: &lint
        name: 'Lint'
        script:
          - ./vendor/bin/pint

pipelines:
  default:
    - step: 
      <<: *build
    - step: 
      <<: *test
    - step: 
      <<: *lint